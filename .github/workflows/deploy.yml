name: Deploy to Supabase

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest
    
    - name: Check Secrets
      run: |
        if [ -z "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ]; then
          echo "âŒ SUPABASE_ACCESS_TOKEN secret is missing"
          exit 1
        fi
        if [ -z "${{ secrets.SUPABASE_PROJECT_REF }}" ]; then
          echo "âŒ SUPABASE_PROJECT_REF secret is missing"
          echo "Please add this secret to your GitHub repository"
          echo "You can find it in your Supabase dashboard under Settings > General"
          exit 1
        fi
        echo "âœ… All required secrets are present"
    
    - name: Link to Supabase Project
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      run: |
        echo "ğŸ”— Linking to Supabase project: $PROJECT_REF"
        supabase link --project-ref $PROJECT_REF
        echo "âœ… Project linked successfully!"
    
    - name: Deploy Edge Functions
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      run: |
        echo "ğŸš€ Deploying to Supabase project: $PROJECT_REF"
        
        # Deploy all functions
        echo "ğŸ“¦ Deploying telegram function..."
        supabase functions deploy telegram
        
        echo "ğŸ“¦ Deploying telegram-webhook function..."
        supabase functions deploy telegram-webhook
        
        echo "ğŸ“¦ Deploying telegram-poll function..."
        supabase functions deploy telegram-poll
        
        echo "ğŸ“¦ Deploying oauth-oura function..."
        supabase functions deploy oauth-oura
        
        echo "ğŸ“¦ Deploying oauth-strava function..."
        supabase functions deploy oauth-strava
        
        echo "ğŸ“¦ Deploying data-sync-oura function..."
        supabase functions deploy data-sync-oura
        
        echo "ğŸ“¦ Deploying daily-briefings function..."
        supabase functions deploy daily-briefings
        
        echo "ğŸ“¦ Deploying oauth-test function..."
        supabase functions deploy oauth-test
        
        echo "ğŸ“¦ Deploying test-db function..."
        supabase functions deploy test-db
        
        echo "âœ… All functions deployed successfully!"
        
    - name: Update Database Schema
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      run: |
        echo "ğŸ—„ï¸ Updating database schema..."
        # Link to the remote project first
        supabase link --project-ref $PROJECT_REF
        # Then push the schema
        supabase db push
        echo "âœ… Database schema updated successfully!"
